\chapter{Bidirectional Conversion}
\label{chap:bidir-conv}

In \cref{chap:bidir-ccw,chap:bidir-pcuic}, we considered typing, and saw how it could be
turned into a bidirectional relation. However, we did not consider \kl{conversion}.
Indeed, since we chose to use an \kl(conv){untyped} notion of conversion, a bidirectional
approach would not have made sense, as there was no type around in conversion.

However, the \kl(conv){typed} presentation of conversion is also a popular one, and in that
setting the question of giving a bidirectional presentation \emph{is} sensible.
Luckily, such a presentation is already available if we go through the literature with the
right glasses on. Indeed, in \sidetextcite{Abel2017},
decidability of conversion is shown by introducing a “conversion algorithm”,
a relation presented via inference rules, but which directly corresponds to
an implementable convertibility check.
This is somewhat similar to how we show decidability of typing
in \arefpart{metacoq} by going through bidirectional typing as an intermediate,
more structured representation.
But the interesting point is that this \kl(conv){typed}%
\sidenote{Type information is used to trigger η-expansion when comparing inhabitants of
a Π-type.},
algorithmic conversion, and it is, in fact, bidirectional!
Indeed, while regular conversion-checking uses the type as
\kl{input}, it is mutually defined with a specific relation to compare \kl{neutrals},
which \kl[inference]{\emph{infers}} a type while checking that the neutrals are convertible.
In this chapter, we re-cast the ideas of \textcite{Abel2017} in our setting,
clearly delineating their bidirectional nature.

Moreover, we can use that bidirectional structure
to show that this typed algorithmic conversion agrees with an untyped one,
close to the conversion algorithm implemented in \kl{Coq}.
This is interesting, because currently \kl{PCUIC} as presented in \kl{MetaCoq}
is not able to handle extensionality rules such as the η-rule for functions.
This is not because we do not know how to handle them in the kernel%
\sidenote{\kl{Coq}’s kernel has an implementation that takes care of extensionality rules
in a term-directed fashion.}
but rather because it is difficult to give a good specification of them in the
\kl(conv){untyped} setting chosen for \kl{MetaCoq}’s conversion.%
\sidenote{I gave a workshop presentation \cite{LennonBertrand2022a} on this issue.}%
\margincite{LennonBertrand2022a}
Thus, this could be a first step towards a specification of
\kl{MetaCoq} using \kl{typed conversion}, which would facilitate the incorporation of
extensionality rules that are currently direly missing to the project.

The chapter is organized as follows: \cref{sec:bidir-conv} introduces the main relation we will
be interested in, namely the bidirectional conversion inspired by \textcite{Abel2017};
\cref{sec:bidir-conv-meta} discusses the difficulties encountered when establishing the
meta-theory of such a system; finally, \cref{sec:unty-conv-equiv} presents the equivalence
between this bidirectional conversion and an untyped one, very close to how \kl{Coq}’s kernel
handles η-rules.

\section{Bidirectional Conversion}
\label{sec:bidir-conv}

\subsection{Extensionality and η-rules}
\label{sec:eta-rules}

Before we can get to bidirectional conversion, let us first go over why using typed conversion
is interesting. Typed conversion is as old as type theory itself \cite{MartinLoef1972},
and there are two main reasons that make it a better choice over untyped conversion.
The first is that it is easier to build models%
\sidenote{Or logical relations, translations…} using typed conversion,
because these can use the extra type information to interpret conversion based on the type.
But the reason that is of interest to us here, as we do not build such
models, are extensionality rules.

In general, extensionality rules allow equating two terms, not based on their shape,%
\sidenote{As is the case of all the rules introduced so far, especially β and ι.}
but on the type. The most basic one is that for functions,
which says that any function $f$ and $g$ of type $\P x : A.\ B$
should be convertible whenever $f\ x \conv g\ x \ty B$ – note that here $f$ and $g$ are
\emph{any} functions.
As their name suggest, this kind of rules constrain the
system to not be too intentional. For instance, in the case of functions, $f$ and $g$ cannot
contain any “hidden” information that disappear when observing their behaviour using
application, because that information would disappear when applying the extensionality rule.
In \kl{Coq}, similar extensionality rules exist for dependent pair types%
\sidenote{Or more generally for record types, which are a generalized version of these,
see \cref{sec:pcuic-ind}.}
– saying that $p$ and $q$ of type $\Sb x : A.\ B$, $p$ and $q$ are convertible whenever
their two components are –
and for strict propositions – saying that whenever $P \ty \SProp$, and $p \ty P$, $q \ty P$,
$p$ and $q$ are convertible.

In the case of functions,%
\sidenote{Something similar happens for record types.}
the extensionality rule is inter-derivable with what is called the η-rule, which equates
$f$ and $\l x : A. f\ x$. While less useful than β-rules, η-rules are still valuable.
For instance, in the setting of homotopy type theory, they are needed to deduce function
extensionality from univalence \sidecite{UniFoundationsProgram2013}.

\subsection{Conversion checks, neutral comparison infers}

If we wish to describe such type-based rules, it is natural to wish for a typing relation
that maintains that type, in order to use it to trigger extensionality rules.
This what happens for instance in \kl{Agda} \sidecite{Norell2007}.%
\sidenote{Although in the specific case of functions,
the \kl{Agda} implementation actually uses the
same term-directed technique as \kl{Coq}, as presented in \cref{sec:unty-conv-equiv}.}
Because the type is maintained, we need the conversion rules to obey McBride’s discipline too.
A nice presentation of this is given by the “algorithmic conversion” of \sidetextcite{Abel2017},
from which we take inspiration here to describe a bidirectional conversion relation for
\kl{CCω}.

The important intuition about this relation is that it actually decomposes conversion in two
relations. On one side, \intro{generic conversion}, that we will continue writing $\bconvop$,
which takes a type as \kl{input} – \ie, it \emph{checks}. On the other side,
\intro{neutral comparison}, written $\nconvop$, which takes a type as \kl{output} – it \emph{infers}.
There are two reasons for this. First, applying extensionality rules on neutrals is
useless, as it will simply create a blocked redex. For instance, if $n$ and $n'$ are neutral
functions, $n\ x$ and $n'\ x$ are convertible exactly when $n$ and $n'$ are. But more
importantly, the inferred information is used to know at which type the recursive appeals to
conversion need to be done. In the case of applications for instance, comparing $n\ t$ with
$n'\ t'$, we need to infer a type $\P x : A.\ B$ while comparing $n$ with $n'$ to recursively
compare $t$ to $t'$ at type $A$.

\begin{figure*}[h]
  \ContinuedFloat*
  \begin{mathpar}
  \inferdef{Check}{\inferty{\Gamma}{t}{T} \\ \bcum{\Gamma}{T}{T'}}{\checkty{\Gamma}{t}{T'}}
    \label{rule:bd-cum-check} \and
  \inferdef{RedCum}{T \hred T' \\ U \hred U' \\ \cumh{\Gamma}{T'}{U'}}{\bcum{\Gamma}{T}{U}}
    \label{rule:bd-red-cum}
  \end{mathpar}
  \caption{\kl{Generic cumulativity}}
  \label{fig:gene-cum}
\end{figure*}

We wish to extend \kl{CCω}, so the rules we present here are meant to complement
the rules of \cref{fig:ccw-bidir-infer,fig:bidir-ccw-other}, replacing \ruleref{rule:bd-check}
of \cref{fig:bidir-ccw-other} by \ruleref{rule:bd-cum-check} of \cref{fig:gene-cum}.
We cannot define a system based purely on \kl{conversion},%
\sidenote{This is due to the product rule, to which we will get soon.}
so we use \kl{generic cumulativity} $\mathord{\bcumop}$ instead.
Note also that there is no known level at which the two types should be compared,
hence \kl{generic cumulativity} “checks”, but against the mere
fact of being a type, rather than against a precise type. This is akin to the relation often
written $\Gamma \vdash T \conv T'$ or $\Gamma \vdash T \conv T'\ Type$ often used in the
setting of Martin-Löf type theory.
To deduce \kl{generic cumulativity},
there is only one rule that applies, \ruleref{rule:bd-red-cum}:
both arguments are reduced to \kl{weak-head} normal forms, before being compared
by the auxiliary relation $\cumhop$.

\begin{figure*}[h]
  \ContinuedFloat
  \begin{mathpar}
    \inferdef{BdNeuCum}{\nconv{\Gamma}{N}{N'}{S}}{\cumh{\Gamma}{N}{N'}}
      \label{rule:bd-neu-cum} \and
    \inferdef{BdUniCum}{i \leq j}{\cumh{\Gamma}{\uni[i]}{\uni[j]}}
      \label{rule:bd-uni-cum} \and
    \inferdef{BdΠCum}{\bconv{\Gamma}{A}{A'} \\ \bcum{\Gamma, x : A}{B}{B'}}
      {\cumh{\Gamma}{\P x : A.\ B}{\P x : A'.\ B'}}
      \label{rule:bd-prod-cum}
  \end{mathpar}
  \caption{\kl{Generic cumulativity} between reduced types}
  \label{fig:gene-cumh}
\end{figure*}

This auxiliary relation, in turn, is defined by the rules of \cref{fig:gene-cumh}, which
either apply congruence rules if both types being compared are \kl{canonical} forms –
Rules \nameref{rule:bd-uni-cum} and \nameref{rule:bd-prod-cum} –, or call
\kl{neutral comparison} otherwise – \ruleref{rule:bd-neu-cum}.

\begin{figure*}[h]
  \ContinuedFloat
  \begin{mathpar}
    \inferdef{RedConvTy}{T \hred T' \\ U \hred U' \\ \convh{\Gamma}{T'}{U'}}
      {\bconv{\Gamma}{T}{U}}\label{rule:bd-red-conv-ty} \and
    \inferdef{BdNeuConvTy}{\nconv{\Gamma}{N}{N'}{S}}{\convh{\Gamma}{N}{N'}}
      \label{rule:bd-neu-conv-ty} \and
    \inferdef{BdUniConvTy}{i = j}{\convh{\Gamma}{\uni[i]}{\uni[j]}}
      \label{rule:bd-uni-conv-ty} \and
    \inferdef{BdΠConvTy}{\bconv{\Gamma}{A}{A'} \\ \bconv{\Gamma, x : A}{B}{B'}}
      {\convh{\Gamma}{\P x : A.\ B}{\P x : A'.\ B'}}
      \label{rule:bd-prod-conv-ty} \and
  \end{mathpar}
  \caption{\kl{Generic conversion} between types}
  \label{fig:gene-conv-ty}
\end{figure*}

\kl{Generic conversion} is defined in \cref{fig:gene-conv-ty}, in a way very similar to
\kl{generic cumulativity}.

\begin{figure*}[h]
  \ContinuedFloat
  \begin{mathpar}
    \inferdef{VarComp}{(x : A) \in \Gamma}{\nconv{\Gamma}{x}{x}{A}}
      \label{rule:neu-comp-var}\and
    \inferdef{AppComp}{\pnconv{\P}{\Gamma}{n}{n'}{\P x : A.\ B} \\ \bconv{\Gamma}{t}{t'}[A]}
      {\nconv{\Gamma}{n\ t}{n\ t'}{\subs{B}{x}{t}}}
      \label{rule:neu-comp-app} \and
    \inferdef{RedComp}{\nconv{\Gamma}{n}{n'}{T} \\ T \hred \P x : A.\ B}{\pnconv{\P}{\Gamma}{n}{n'}{\P x : A.\ B}}
      \label{rule:neu-comp-red}
  \end{mathpar}
  \caption{\kl{Neutral comparison}}
  \label{fig:neu-comp}
\end{figure*}

Next, we get to \kl{neutral comparison}, in \cref{fig:neu-comp}. Neutrals are
related exactly when they are the same variable, applied to two lists of recursively convertible arguments. The interesting rule is \ruleref{rule:neu-comp-app}, where we see
the behaviour described earlier: the domain of the inferred type for the neutral is used to
compare the arguments.

\begin{figure*}[h]
  \ContinuedFloat
  \begin{mathpar}
    \inferdef{RedConvTm}{t \hred t' \\ u \hred u' \\ A \hred A' \\ \convh{\Gamma}{t'}{u'}[A']}
      {\bconv{\Gamma}{t}{u}[A]}\label{rule:bd-red-conv-tm} \and
    \inferdef{BdNeuConvUni}{\nconv{\Gamma}{n}{n'}{S}}{\convh{\Gamma}{n}{n'}[\uni[i]]}
      \label{rule:bd-neu-conv-uni} \and
    \inferdef{BdNeuConvNeu}{\nconv{\Gamma}{n}{n'}{S} \\ \ne N}{\convh{\Gamma}{n}{n'}[N]}
      \label{rule:bd-neu-conv-neu} \and
    \inferdef{BdUniConvTm}{i = j}{\convh{\Gamma}{\uni[i]}{\uni[j]}[\uni[k]]}
      \label{rule:bd-uni-conv-tm} \and
    \inferdef{BdΠConvTm}{\bconv{\Gamma}{A}{A'}[\uni[i]] \\
      \bconv{\Gamma, x : A}{B}{B'}[\uni[i]]}
      {\convh{\Gamma}{\P x : A.\ B}{\P x : A'.\ B'}[\uni[i]]}
      \label{rule:bd-prod-conv-tm}
  \end{mathpar}
  \caption{\kl{Generic conversion} between terms at the universe}
  \label{fig:gene-conv-tm}
\end{figure*}

Finally, we get to \kl{generic conversion} between terms, which is called recursively by
\kl{neutral comparison}.
The first set of rules, given in \cref{fig:gene-conv-tm} is very similar to the one for types.
First, the two terms are reduced, and the type at which they are compared too,
and the terms are then compared using relation $\convhop$
(\ruleref{rule:bd-red-conv-tm}). If the terms are neutrals, \kl{neutral comparison} is used
(Rules \nameref{rule:bd-neu-conv-uni} and \nameref{rule:bd-neu-conv-neu}). This is only possible
if the type is a universe or a neutral. Indeed, to keep the relation deterministic, this
rule cannot be applied at a Π-type, where extensionality \emph{must} be applied.

Otherwise, congruence rules must be used. In case the comparison happens at the universe, 
these are very similar to that for types (Rules \nameref{rule:bd-uni-conv-tm} and
\nameref{rule:bd-prod-conv-tm}).
Note however, that to maintain the well-formedness invariant mandated by McBride’s discipline,
we should always call $\bconv{\Gamma}{t}{t'}{A}$ when we know that both $t$ and $t'$
check against $A$. But in \ruleref{rule:bd-prod-conv-tm}, the domains and codomains might be at
a universe level lower that $i$ even if the whole product is at that level.%
\sidenote{For instance, $A$ might be $\uni[0]$ and $B$ might be $\uni[1]$, so that $A \to B$
is at level $2$ but $A$ is at level $1$.}
Thus, in order to recursively compare $A$ to $A'$ and $B$ to $B'$, we must know that they still
check against $\uni[i]$, which requires \kl{cumulativity}.

\begin{figure}[h]
  \ContinuedFloat
  \begin{mathpar}
    \inferdef{BdFunConv}{
      \bconv{\Gamma, x : A}{f\ x}{f'\ x}[B]}
      {\convh{\Gamma}{f}{f'}[\P x : A.\ B]}
      \label{rule:bd-fun-conv}
  \end{mathpar}
  \caption{\kl{Generic conversion} between functions}
  \label{fig:gene-conv-fun}
\end{figure}

The last rule is that for comparing two functions (\ruleref{rule:bd-fun-conv}).
In that case, an extensionality rule is directly applied without even looking
at the two terms. There is thus no congruence rule for λ-abstractions, but it is actually
derivable, because $(\l x : A.\ t)\ x \hred t$, and so in case both $f$ and $f'$ are
abstractions, the recursive calls amount to comparing their bodies.

The rules as given directly translate to an algorithm, as they nicely term/type directed,
\ie there is always at most one rule that applies to derive a judgment. Moreover,
if in \kl{generic cumulativity} and \kl{generic conversion} we view all objects as \kl{inputs}%
\sidenote{The subject is the “computational content” of the judgment, \ie whether the
conversion/cumulativity holds. This is similar to the conversion judgments of
\textcite{Bauer2020}.}
\margincite{Bauer2020}
in \kl{neutral comparison} the type is an \kl{output} and all other objects are inputs,
and in \kl{reduction} $t \hred t'$, $t$ is an \kl{input} and $t'$ is an \kl{output}, then
all rules respect McBride’s discipline.

\section{Untyped Presentation}
\label{sec:unty-conv-equiv}

In the presentation of \cref{sec:bidir-conv}, types are carried around,
but almost never used. Indeed,
only \ruleref{rule:bd-fun-conv} really needs the type information to be applied.
However, there is an alternative approach, which is the one used by the kernels of \kl{Coq}
and \kl{Agda}, which avoids looking at types altogether, by replacing \ruleref{rule:bd-fun-conv}
by term-directed rather than type-directed ones.
As we do not want to maintain types, there is also no point in maintaining the context either.
Thus, this alternative \kl{conversion} is of the following form: $\buconv{\gamma}{t}{t'}$.
Let us now spell out the rules for this alternative, untyped presentation.

\begin{figure*}[h]
  \ContinuedFloat*
  \begin{mathpar}
  \inferdef{CheckUty}{\inferty{\Gamma}{t}{T} \\ \bucum{\left| \Gamma \right|}{T}{T'}}{\checkty{\Gamma}{t}{T'}}
    \label{rule:bd-ucum-check} \and
  \inferdef{RedCumUty}{t \hred t' \\ u \hred u' \\ \ucumh{\gamma}{t'}{u'}}
    {\bucum{\gamma}{t}{u}} \label{rule:bd-red-ucum} \and
  \inferdef{RedConvUty}{t \hred t' \\ u \hred u' \\ \uconvh{\gamma}{t'}{u'}}
    {\buconv{\gamma}{t}{u}} \label{rule:bd-red-uconv} \and
  \inferdef{BdNeuCumUty}{\nuconv{\gamma}{n}{n'}}{\ucumh{\gamma}{n}{n'}}
    \label{rule:bd-neu-ucum} \and
  \inferdef{BdNeuConvUty}{\nuconv{\gamma}{n}{n'}}{\uconvh{\gamma}{n}{n'}}
    \label{rule:bd-neu-uconv} \and
  \end{mathpar}
  \caption{Untyped cumulativity and conversion}
  \label{fig:gene-ucum}
\end{figure*}

The first rules of \cref{fig:gene-ucum} are similar to those for the typed variants: cumulativity can be used
in checking, and terms are compared by first reducing them to weak-head normal form, and if they are neutrals
the special \kl{neutral comparison} is called.

\begin{figure}[h]
  \ContinuedFloat
  \begin{mathpar}
  \inferdef{BdUniCumUty}{i \leq j}{\ucumh{\gamma}{\uni[i]}{\uni[j]}}
    \label{rule:bd-uni-ucum} \and
  \inferdef{BdΠCumUty}{\buconv{\gamma}{A}{A'} \\
    \bucum{\gamma, x}{B}{B'}}
    {\ucumh{\gamma}{\P x : A.\ B}{\P x : A'.\ B'}}
    \label{rule:bd-prod-ucum} \\
  \inferdef{BdUniConvUty}{i = j}{\uconvh{\gamma}{\uni[i]}{\uni[j]}}
    \label{rule:bd-uni-uconv} \and
  \inferdef{BdΠConvUty}{\buconv{\gamma}{A}{A'} \\
    \buconv{\gamma, x}{B}{B'}}
    {\uconvh{\gamma}{\P x : A.\ B}{\P x : A'.\ B'}}
    \label{rule:bd-prod-uconv}
  \end{mathpar}
  \caption{Untyped bidirectional conversion for types}
  \label{fig:bd-cong-univ}
\end{figure}

The rules for the comparison of types are given in \cref{fig:bd-cong-univ}, and are again
very similar to those for the typed variant: there is a congruence rule for Π-types,
and universes are convertible when their levels are in the right relation.

\begin{figure}[h]
  \ContinuedFloat
  \begin{mathpar}
    % \inferdef{VarCompUty}{(x : A) \in \gamma}{\nuconv{\gamma}{x}{x}}
    \inferdef{VarCompUty}{ }{\nuconv{\gamma}{x}{x}}
      \label{rule:neu-ucomp-var}\and
    \inferdef{AppCompUty}{\nuconv{\gamma}{n}{n'} \\ \buconv{\gamma}{t}{t'}}
      {\nuconv{\gamma}{n\ t}{n\ t'}}
      \label{rule:neu-ucomp-app}
  \end{mathpar}
  \caption{Untyped \kl{neutral comparison}}
  \label{fig:neu-ucomp}
\end{figure}

In the case of \kl{neutral comparison}, the rules (\cref{fig:neu-ucomp}) are even simpler
than in the typed case, because there is no need for a special rule to reduce the type,
as they are not maintained. Thus, there are only two rules, one for application and one
base case for variables.

\begin{figure}[h]
  \ContinuedFloat
  \begin{mathpar}
  \inferdef{BdAbsCong}{\buconv{\gamma,x}{t}{t'}}
    {\uconvh{\gamma}{\l x : A.\ t}{\l x : A'.\ t'}} \label{rule:bd-abs-uconv} \\
  \inferdef{BdAbsNeu}{\buconv{\gamma,x}{t}{n'\ x} \\ \ne{n'}}{\uconvh{\gamma}{\l x : A.\ t}{n'}}
    \label{rule:bd-abs-neu} \and
  \inferdef{BdNeuAbs}{\buconv{\gamma,x}{n\ x}{t'} \\ \ne{n}}{\uconvh{\gamma}{n}{\l x : A'.\ t'}}
    \label{rule:bd-neu-abs}
  \end{mathpar}
  \caption{Untyped, bidirectional conversion for functions}
  \label{fig:bd-uconv-fun}
\end{figure}

Finally, the interesting difference appears in \cref{fig:bd-uconv-fun}. Here what was done
using only one generic rule (\ruleref{rule:bd-fun-conv}) is decomposed into four of them,
depending on whether each function in weak-head normal form is a neutral or an abstraction.
In case both are abstractions, the extensionality rules amounts to a congruence, \ie
\ruleref{rule:bd-abs-uconv}.%
\sidenote{If we maintain the invariant that both terms that are compared have a common type,
then there is no need to compare the domains of the abstractions because they are always
convertible.} 
In case both are neutrals, the extensionality rule only inserts
a useless application to a variable, but \kl{neutral comparison} can be directly used
instead. The only setting where the extensionality rule is useful is when comparing a neutral
to an abstraction. But in those cases, the information that the comparison happens at a function
type and that the neutral needs to be η-expanded can be obtained from the abstraction.
This is what the symmetric Rules \nameref{rule:bd-abs-neu} and \nameref{rule:bd-neu-abs} do.

\section{McBride’s Discipline}

\subsection{Modes for the relations}

As we have seen in \cref{sec:bidir-mcbride}, for a bidirectional system to be well-behaved,
it must preserve the well-formation of its components as an invariant. First, we need to
distinguish \kl{subjects}, \kl{inputs} and \kl{outputs} of the judgments. In all cases, the
\kl{subject}%
\sidenote{That which is under scrutiny.}
is not a term as in typing, but rather whether a certain relation holds.
As in the case of the typing relation, the context is always an \kl{input}. In all
“conversion”-style relations, \ie \kl{cumulativity}, \kl{conversion} and
\kl{neutral comparison}, the two terms are also \kl{inputs}, since we wonder whether
two \emph{given} terms are related. This is contrast with \kl{reduction}, where only the
redex is an \kl{input}, while the reduct is an output. This separation already appeared
in \cref{sec:bidir-mcbride}. Finally, as hinted by the use of the inference \textit{versus}
checking symbols, the type is an \kl{output} in \kl{neutral comparison}, while it is an
\kl{input} in conversion and cumulativity. As for the type-level relations%
\sidenote{That is, $\bcum{\Gamma}{T}{T'}$ and consort.}
there is no real input, only the knowledge that the comparison happens at the type
level, which is similar to performing the comparison at some $\uni[i]$ for an unspecified $i$.

With these set down, the following definitions of \kl{inputs} and \kl{outputs}
well-formation are rather natural.

\begin{definition}[Inputs well-formation – typed relations]
  We say that “inputs are well-formed” for one of the relations of \cref{fig:gene-cum,fig:gene-cumh,fig:gene-conv-ty,fig:neu-comp,fig:gene-conv-tm,fig:gene-conv-fun}
  to mean the following:
  \begin{itemize}
    \item in the case of $\bconv{\Gamma}{t}{t'}[T]$ and of $\convh{\Gamma}{t}{t'}[T]$,
      that $\vdash \Gamma$,
      that there exists $i$ such that $\pinferty{\uni}{\Gamma}{T}{\uni[i]}$,
      and that $\checkty{\Gamma}{t}{T}$ and $\checkty{\Gamma}{t'}{T}$;
    \item in the case of $\bconv{\Gamma}{T}{T'}$, $\convh{\Gamma}{T}{T'}$,
      $\bcum{\Gamma}{T}{T'}$ and $\cumh{\Gamma}{T}{T'}$, that $\vdash \Gamma$,
      and that there exist $i$ and $j$ such that $\pinferty{\uni}{\Gamma}{T}{\uni[i]}$
      and $\pinferty{\uni}{\Gamma}{T'}{\uni[j]}$;
    \item in the case of $\nconv{\Gamma}{n}{n'}{S}$ and of $\pnconv{\P}{\Gamma}{n}{n'}{S}$,
      that $\vdash \Gamma$,
      and that there exists $T$ and $T'$ such that $\inferty{\Gamma}{n}{T}$ and
      $\inferty{\Gamma}{n'}{T'}$.%
      \sidenote{Note that we do not \textit{a priori} demand that $S$ be related to $T$, 
      as this is a well-formation property of the \emph{\kl{output}} $S$.}
  \end{itemize}
\end{definition}

\begin{definition}[Inputs well-formation – untyped relations]
  We say that “inputs are well-formed” for one of the relations of \cref{fig:gene-ucum,fig:bd-cong-univ,fig:neu-ucomp,fig:bd-uconv-fun}
  to mean the following:
  \begin{itemize}
    \item in the case of $\buconv{\gamma}{t}{t'}$ and of $\uconvh{\gamma}{t}{t'}$,
      that there exists some $\Gamma$, $T$ and $i$ such that $\vdash \Gamma$,
      $\pinferty{\uni}{\Gamma}{T}{\uni[i]}$,
      and $\checkty{\Gamma}{t}{T}$ and $\checkty{\Gamma}{t'}{T}$ hold;
    \item in the case of $\nuconv{\gamma}{n}{n'}$,
      that there exists some $\Gamma$, $T$ and $T'$ such that $\vdash \Gamma$,
      $\inferty{\Gamma}{n}{T}$ and $\inferty{\Gamma}{n'}{T'}$.
  \end{itemize}
  Moreover, we say that “inputs are well-formed types” in the case of
  $\buconv{\gamma}{T}{T'}$, $\uconvh{\gamma}{T}{T'}$,
  $\bucum{\gamma}{T}{T'}$ and $\ucumh{\gamma}{T}{T'}$, to mean the existence of $\Gamma$,
  $i$ and $j$ such that $\vdash \Gamma$,
  $\pinferty{\uni}{\Gamma}{T}{\uni[i]}$ and $\pinferty{\uni}{\Gamma}{T'}{\uni[j]}$.
\end{definition}

\begin{definition}[Outputs well-formation]
  We say that “outputs are well-formed” for \kl{neutral comparison} between two
  terms $n$ and $n'$ assumed to be well-typed to mean the following:
  \begin{itemize}
    \item in the case of $\nconv{\Gamma}{n}{n'}{T}$, that $\inferty{\Gamma}{n}{T}$ holds,
      and also $\inferty{\Gamma}{n'}{T'}$, with $\bconv{\Gamma}{T}{T'}$;
    \item in the case of $\pnconv{\P}{\Gamma}{n}{n'}{\P x : A.\ B}$,
      that $\pinferty{\P}{\Gamma}{n}{\P x : A.\ B}$,
      and moreover $\pinferty{\P}{\Gamma}{n'}{\P x : A'.\ B'}$,
      with $\bconv{\Gamma}{\P x : A.\ B}{\P x : A'.\ B'}$ all hold.
  \end{itemize}
\end{definition}

\subsection{Meta-theory of the bidirectional system}

Let us now try and see what meta-theoretical properties we need of the typed system to
show that its rules respect McBride’s discipline.

In the case of Rules \nameref{rule:bd-red-cum}, \nameref{rule:bd-red-conv-ty} and
\nameref{rule:bd-red-conv-tm}, the well-formation of \kl{inputs} to the last premise
under the hypothesis that \kl{inputs} to the conclusion are well-formed is exactly
\kl{subject reduction}. In the case of a β-redex, \kl{subject reduction} is equivalent
to the following weak version of stability by substitution.

\begin{property}[Weak stability of typing by substitution]
  \label{prop:weak-ty-sub-stab}
  If $\inferty{\Gamma,x : A}{t}{T}$ and $\checkty{\Gamma}{u}{A}$ hold and their inputs
  are well-formed, then $\checkty{\Gamma}{\subs{t}{x}{u}}{\subs{T}{x}{u}}$.
\end{property}

A similar property appears even more directly in the case of \kl{neutral comparison},
this time regarding \kl{output} well-formation in \ruleref{rule:neu-comp-app}.
Indeed, in that case by \kl{output} well-formation of in premises, we can assume that
$\pinferty{\P}{\Gamma}{n'}{\P x : A'.\ B'}$, with
$\bconv{\Gamma}{\P x : A.\ B}{\P x : A'.\ B'}$, and we need to show that
$\bconv{\Gamma}{\subs{B}{x}{t}}{\subs{B'}{x}{t'}}$. Again, the main property here
is a form of stability by substitution.

\begin{property}[Weak stability of conversion by substitution]
  \label{prop:weak-conv-sub-stab}
  If $\bconv{\Gamma,x : A}{t}{t'}{T}$ and $\bconv{\Gamma}{u}{u'}[A]$
  and their inputs are well-formed, then
  $\bconv{\Gamma}{\subs{t}{x}{u}}{\subs{t'}{x}{u'}}[\subs{T}{x}{u}]$.
\end{property}

However, here lies an important difficulty: \cref{prop:weak-conv-sub-stab} implies
\kl{normalization}. To see why, a first remark: congruence of conversion holds for
all canonical forms, respectively by Rules \nameref{rule:bd-prod-conv-tm} and
\nameref{rule:bd-uni-conv-tm}, and by the following lemma.

\begin{lemma}[Congruence of abstraction]
  \label{lem:bd-abs-cong}
  If $\bconv{\Gamma, x : A}{t}{t'}{B}$ then
  $\bconv{\Gamma}{\l x : A.\ t}{\l x : A'.\ t'}[\P x : A.\ B]$.%
  \sidenote{For this lemma, there is no need for a relation between $A$ and $A'$,
  but for the inputs to the conclusion to be well-formed,
  we should also have $\bconv{\Gamma}{A}{A'}$.}
\end{lemma}

\begin{proof}
  First, conversion is stable by anti-reduction, \ie if $\bconv{\Gamma}{u_2}{u_2'}[U_2]$ holds
  and $u_1 \hred u_2$, $u_1' \hred u_2'$ and $U_1 \hred U_2$
  then $\bconv{\Gamma}{u_1}{u_1'}[U_1]$.
  Indeed, if the former holds, it must be by an application of \ruleref{rule:bd-red-conv-tm},
  and so there are $u_3$ and $u_3'$ and $U_3$ such that $\convh{\Gamma}{u_3}{u_3'}[U_3]$,
  and they are respective reducts of $u_2$, $u_2'$ and $U_2$. But the also $u_1 \hred u_3$
  and similarly for the other two, and so we can use again \ruleref{rule:bd-red-conv-tm}.
  
  Now, by an application of \ruleref{rule:bd-fun-conv}, we only need to show
  $\bconv{\Gamma,x : A}{(\l x : A.\ t)\ x}{(\l x : A'.\ t')\ x}{B}$, and we can use
  stability by anti-reduction to conclude.
\end{proof}

Moreover, if we assume \cref{prop:weak-conv-sub-stab}, then congruence also holds
for application.

\begin{lemma}[Congruence of application]
  Assuming \cref{prop:weak-conv-sub-stab}, we have that if
  $\bconv{\Gamma}{t}{t'}{\P x : A.\ B}$ and $\bconv{\Gamma}{u}{u'}{A}$
  and their inputs are well-formed,
  then also $\bconv{\Gamma}{t\ u}{t'\ u}{\subs{B}{x}{u}}$.
\end{lemma}

\begin{proof}
  The only way to obtain the first premise is to apply \ruleref{rule:bd-red-cum} and
  \ruleref{rule:bd-fun-conv}. Thus, we have that $t \hred f$, $t' \hred f'$ and
  $\bconv{\Gamma, x : A}{f\ x}{f'\ x}{B}$. By \cref{prop:weak-conv-sub-stab}, we have
  $\bconv{\Gamma}{\subs{f\ x}{x}{u}}{\subs{f'\ x}{x}{u'}}{\subs{B}{x}{u}}$.
  But since we assume no shadowing happens, $x$ does not appear in $f$ or $f'$, so that
  we actually have $\bconv{\Gamma}{f\ u}{f'\ u'}{\subs{B}{x}{u}}$.
  Now stability by anti-reduction is enough to conclude.
\end{proof}

Applying all these congruences in the diagonal case, we obtain reflexivity of conversion.

\begin{proposition}[Reflexivity]
  Assuming \cref{prop:weak-conv-sub-stab}, if $\vdash \Gamma$ and
  $\inferty{\Gamma}{t}{T}$, then also $\bconv{\Gamma}{t}{t}{T}$.
\end{proposition}

\begin{proof}
  By induction on the typing derivation, using the previous congruences in each case.
\end{proof}

But since conversion amounts to iterated weak-head normalization of both terms,
reflexivity implies \kl{normalization}, in the following sense.

\begin{proposition}[Normalization]
  Assuming \cref{prop:weak-conv-sub-stab}, if $\inferty{\Gamma}{t}{T}$ and
  $\vdash \Gamma$, then there is some normal form $t'$ such that $t \red t'$.
\end{proposition}

Thus, if we wished to establish that our rules respect McBride’s discipline, we
would need a proof technique able to show normalization of the system under consideration.
In the case of a “toy” system such as that of this chapter, a technique close to the logical
relation of \sidecite{Abel2017} might be enough. In a more complex setting, especially if
we add an impredicative sort of propositions, proofs of normalization are scarcer and
further from the presentations of this chapter \sidecite{Werner1994,Altenkirch1993}.
An alternative solution, following \kl{MetaCoq},
would be to assume a property such as normalization and derive the needed meta-theory from
that single assumption \sidecite{Sozeau2020}.

In any case, a substantial meta-theoretical study would be needed, one that I do not wish
to pursue further here. Thus, let us simply \emph{assume} the properties
we need for McBride’s discipline to be correctly maintained in both presentations.
Apart from stability by substitution and subject reduction that we have already mentioned,
the main properties we would need are those necessary to handle the left-biais of rules.
% For instance, in \kl{neutral comparison}, the inferred type is that of the left term,%
% \sidenote{See the substitution with the left argument in \ruleref{rule:neu-comp-app}.}
% so that in \ruleref{rule:neu-comp-app} the conversion of the second premise is used at a
% type $A$ but for the right term $t'$ we only know that it checks against some $A'$ that
% is convertible to $A$.
For instance, in \ruleref{rule:bd-prod-cum},
the context is extended with some $A$, but
we only know that $B'$ is a type in a context extended by $A'$, which is convertible to $A$.
Similarly, in the second premise of \ruleref{rule:neu-comp-app}, the recursive conversion
happens at type $A$, but $t'$ is only known to check against some $A'$ which is convertible
to $A$.

\begin{property}[Subject reduction]
  \label{prop:bd-conv-sr}
  If $\checkty{\Gamma}{t}{T}$ and $t \hred t'$ then $\checkty{\Gamma}{t'}{T}$.
\end{property}

\begin{property}[Stability by context and type conversion]
  \label{prop:bd-stab-conv}
  Let $\Gamma$ and $\Gamma'$ be two well-formed context that are pointwise convertible
  and $T$, $T'$ be two well-formed types – respectively in $\Gamma$ and $\Gamma'$ –,
  such that $\bconv{\Gamma}{T}{T'}$.
  Then if $\checkty{\Gamma}{t}{T}$ then $\checkty{\Gamma'}{t}{T'}$, and
  if $\pinferty{\uni}{\Gamma}{U}{\uni[i]}$ then $\pinferty{\uni}{\Gamma'}{U}{\uni[i]}$.
\end{property}

\begin{conjecture}[Meta-theoretical properties]
  \label{conj:wf-pres-ty}
  \Cref{prop:weak-ty-sub-stab,prop:weak-conv-sub-stab,prop:bd-conv-sr,prop:bd-stab-conv}
  hold.
\end{conjecture}

With this conjecture in hand, we can show that McBride’s discipline is preserved, giving
the following.

\begin{proposition}[Input well-formation – untyped]
  If one of the relations of \cref{fig:gene-ucum,fig:bd-cong-univ,fig:neu-ucomp,fig:bd-uconv-fun}
  holds and its inputs are well-formed, then inputs to any sub-derivation are also well-formed
  and outputs are too.
\end{proposition}

\begin{proof}
  The proof is by mutual induction, and similar to the typed case.
\end{proof}

\begin{proposition}[Input well-formation – untyped]
  If one of the relations of \cref{fig:gene-cum,fig:gene-cumh,fig:gene-conv-ty,fig:neu-comp,fig:gene-conv-tm,fig:gene-conv-fun}
  holds and its inputs are well-formed, then inputs to any sub-derivation are also well-formed
  and outputs are too.
\end{proposition}

\section{Equivalence of the presentations}

With the meta-theoretical requirement exposed, we can now turn to the part of interest to us: the equivalence between both
presentations.

\paragraph{Typed to untyped}
In this direction, the main rule that needs looking at is that which differs between the two systems,
\ie \ruleref{rule:bd-fun-conv}.
This is taken care of by the following lemma.

\begin{lemma}[Injectivity of η-expansion]
  \label{lem:inj-eta}
  If $\convh{\Gamma}{f}{f'}{\P x : A.\ B}$ holds, its inputs are well-formed, and $\buconv{| \Gamma |,x}{f\ x}{f'\ x}$ holds too,
  then $\uconvh{| \Gamma |}{f}{f'}$.
\end{lemma}

\begin{proof}
  By inversion on $\convh{\Gamma}{f}{f'}{\P x : A.\ B}$, we know that $f\ x$ and $f'\ x$ reduce to weak-head normal forms,
  say $f\ x \hred v$, $f'\ x \hred v'$ and by
  inversion on these derivations, we get that also $f$ and $f'$ reduce to weak-head normal forms, say
  $f \hred w$ and $f' \hred w'$.
  By inversion on $\buconv{| \Gamma |,x}{f\ x}{f'\ x}$ and because weak-head normal forms are unique,
  we also get that and $\uconvh{| \Gamma |,x}{v}{v'}$.
  Moreover, because of input well-formation and \kl{subject reduction}, we know that both $w$ and $w'$
  check against $\P x : A.\ B$. Since they are weak-head normal forms, they must thus be either λ-abstractions, or neutrals.
  We thus have four cases to consider.

  In case both $w$ and $w'$ are λ-abstractions, say respectively $\l x : A.\ t$ and $\l x : A'.\ t'$, we have that
  $f\ x \hred w\ x \hored t$, and similarly $f'\ x \hred t'$. Because weak-head reduction is deterministic,
  we must have $t \hred v$ and $t' \hred v'$, but then since $\uconvh{| \Gamma |,x}{v}{v'}$ we also have
  $\buconv{|\Gamma |,x}{t}{t'}$. Thus, we can apply \ruleref{rule:bd-abs-uconv} and conclude.

  In case $w$ is a λ-abstraction, say $\l x : A.\ t$ and $w'$ is a neutral $n'$, then $v'$ must be equal to $n'\ x$.
  Then we have $f\ x \hred w\ x \hored t \hred v$, and thus $\buconv{|\Gamma|,x}{t}{n'\ x}$ since $\uconvh{|\Gamma|,x}{v}{n'\ x}$.
  Thus, \ruleref{rule:bd-abs-neu} applies to conclude. The reasoning in the symmetric case where $w'$ is an abstraction
  and $w$ is not is similar.

  In the last case, both $w$ and $w'$ are neutrals, say $n$ and $n'$. Then $v$ and $v'$ are respectively $n\ x$ and $n'\ x$.
  Since $\uconvh{|\Gamma|,x}{n\ x}{n'\ x}$, we must have also $\nuconv{|\Gamma|,x}{n\ x}{n'\ x}$ because all rules but
  \ruleref{rule:bd-neu-uconv} equate canonical forms. But then the last rule that applies must have been
  \ruleref{rule:neu-comp-app}, and thus we have $\nuconv{|\Gamma|,x}{n}{n'}$. From this, we can get $\uconvh{|\Gamma|,x}{n}{n'}$
  and since $f \hred n$ and $f' \hred n'$, we finally obtain $\buconv{|\Gamma|,x}{f}{f'}$, as expected.
\end{proof}


\begin{theorem}[Typed to untyped bidirectional conversion]
  The following implications hold whenever inputs are well-formed:
  \begin{itemize}
    \item if $\bconv{\Gamma}{t}{t'}{T}$ or $\bconv{\Gamma}{t}{t'}$, then $\buconv{| \Gamma |}{t}{t'}$;
    \item if $\bcum{\Gamma}{T}{T'}$, then $\bucum{|\Gamma|}{T}{T'}$;
    \item if $\convh{\Gamma}{t}{t'}{T}$ or $\convh{\Gamma}{t}{t'}$ then $\uconvh{| \Gamma |}{t}{t'}$;
    \item if $\nconv{\Gamma}{n}{n'}{T}$ or $\pnconv{\P}{\Gamma}{n}{n'}{T}$ then $\nuconv{| \Gamma |}{n}{n'}$.
  \end{itemize}
\end{theorem}

\begin{proof}
  Once again, by mutual induction.

  Most cases are direct, the induction hypothesis can directly be combined to give the desired result, replacing a typed rule
  by its untyped counterpart. The only difficulty is for the one rule which does not have an untyped counterpart, namely
  \ruleref{rule:bd-fun-conv}. But in that case, \cref{lem:wf-pres-ty} ensures that inputs are well-formed since we
  started from a rule with well-formed inputs, and combining this with the induction hypothesis we get exactly
  the hypotheses of \cref{lem:inj-eta}. Applying that lemma, we get the desired result.
\end{proof}

\paragraph{From untyped to typed}

Here again, the main lemma is to show that the rules of \cref{fig:bd-uconv-fun} can be simulated by \ruleref{rule:bd-fun-conv}.
\Cref{lem:bd-abs-cong} already gives the congruence of abstractions, corresponding to \ruleref{rule:bd-abs-uconv}.
In the case of \ruleref{rule:bd-abs-neu} – and its symmetric \ruleref{rule:bd-neu-abs}–, this is rather direct.

\begin{lemma}[Neutral against abstraction]
  \label{lem:neu-abs}
  If $\bconv{\Gamma}{t}{n'\ x}{B}$, $\vdash \Gamma$, and there exists a $T$ such that
  $\checkty{\Gamma}{\l x : A.\ t}{T}$, then
  $T \red \P x : A'. B'$ and $\convh{\Gamma}{\l x : A.\ t}{n'}[\P x : A'.\ B']$.
\end{lemma}

\begin{proof}
  By inversion on $\checkty{\Gamma}{\l x : A.\ t}{T}$, we get that $T$ must be convertible to the type
  inferred for $\l x : A.\ t$. But that inferred type is a Π-type, so $T$ must also reduce to a Π-type.
  An application of \ruleref{rule:bd-fun-conv} and stability of conversion by anti-reduction is enough
  to get $\convh{\Gamma}{\l x : A.\ t}{n'}[\P x : A'.\ B']$ from the first hypothesis.
\end{proof}

But the main difficulty comes from \ruleref{rule:bd-neu-uconv}. Indeed, this rule can be applied whenever
the compared terms are neutral while in the typed relation, following \sidecite{Abel2017}, extensionality
for functions takes precedence over neutral comparison at Π-types. Thus, to simulate \ruleref{rule:bd-neu-uconv}
we need to show \kl{neutral comparison} is always included in conversion, even if neutrals get η-expanded.

\begin{lemma}[Conversion subsumes neutral comparison]
  \label{lem:nconv-conv}
  If $\nconv{\Gamma}{n}{n'}{S}$ and $\bcum{\Gamma}{S}{T}$ hold with well-formed inputs, then
  $\bconv{\Gamma}{n}{n'}{T}$.
\end{lemma}

\begin{proof}
  By induction on the cumulativity hypothesis.

  Both $S$ and $T$ reduce respectively to $S'$ and $T'$, and then one of the three rules of \cref{fig:gene-cumh}
  applies: $S'$ and $T'$ are either both neutrals, both universes, or both product types.
  In the first two cases, we are in a base case: either \ruleref{rule:bd-neu-conv-uni} or \ruleref{rule:bd-neu-conv-neu}
  applies. In the last case, however, only \ruleref{rule:bd-fun-conv} applies, \ie the neutrals get η-expanded.
  Thus, $S'$ is some $\P x : A.\ B$, and $T'$ is some $\P x : A'.\ B'$.
  But then we still have $\nconv{\Gamma, x : A}{n\ x}{n'\ x}{B}$, so the induction hypothesis on the codomains can be
  used to conclude.
\end{proof}

We now have all ingredients for the second implication.

\begin{theorem}[Untyped to typed bidirectional conversion]
  If inputs are well-formed, then the following implications hold, with $\Gamma$ and $T$ being the respective
  context and type of the input well-formation hypothesis:
  \begin{itemize}
    \item if $\buconv{|\Gamma|}{t}{t'}$ then $\bconv{\Gamma}{t}{t'}{T}$;
    \item if $\uconvh{|\Gamma|}{t}{t'}$ and $T$ is a weak-head normal form, then $\convh{\Gamma}{t}{t'}[T]$;
    \item if $\nuconv{|\Gamma|}{n}{n'}$ then $\nconv{\Gamma}{n}{n'}{T}$.
  \end{itemize}
  If inputs are well-formed types, then the following implications hold, with $\Gamma$ the context of the
  input well-formation hypothesis:
  \begin{itemize}
    \item if $\buconv{|\Gamma|}{T}{T'}$ then $\bconv{\Gamma}{T}{T'}$;
    \item if $\uconvh{|\Gamma|}{T}{T'}$ then $\convh{\Gamma}{T}{T'}$;
    \item if $\bucum{|\Gamma|}{T}{T'}$ then $\bcum{\Gamma}{T}{T'}$;
    \item if $\ucumh{|\Gamma|}{T}{T'}$ then $\cumh{\Gamma}{T}{T'}$.
  \end{itemize}
\end{theorem}

\begin{proof}
  By mutual induction. Most rules can be directly replaced by (one of) their typed counterpart, but for those which
  do not have such a counterpart, namely those of \cref{fig:bd-uconv-fun}, and \ruleref{rule:bd-neu-uconv} in case
  its arguments are terms – if they are types, then \ruleref{rule:bd-neu-cum} applies. In each case, one of
  \cref{lem:bd-abs-cong,lem:neu-abs,lem:nconv-conv} is enough to conclude.
\end{proof}